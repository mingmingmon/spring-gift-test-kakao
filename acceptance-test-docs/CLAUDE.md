# CLAUDE.md

## 1. 이 프로젝트에서의 목표

이 프로젝트에서 Claude Code는
레거시 시스템의 "External Behavior(외부 행동)"를 보호하는
행동 기반 인수 테스트를 설계하고 구현하는 것을 돕는다.

이 테스트의 목적은 내부 구현을 검증하는 것이 아니라,
사용자 관점에서 관찰 가능한 비즈니스 결과를 고정하는 것이다.

---

## 2. 핵심 개념

### 2.1 External Behavior란 무엇인가?

External Behavior는 시스템 외부에서 관찰 가능한 결과를 의미한다.

예:
- 주문하면 주문이 생성된다.
- 결제하면 잔액이 차감된다.
- 재고가 부족하면 요청이 실패한다.
- 실패 시 상태는 변경되지 않는다.

External Behavior는 다음으로 드러난다:
- HTTP 응답 (상태 코드, 응답 바디)
- 에러 계약 (에러 코드, 메시지)
- 후속 API 조회로 확인되는 상태 변화
- 비즈니스 결과 (재고 감소, 잔액 차감 등)

Claude는 이러한 외부 행동을 보호하는 테스트만을 작성해야 한다.

---

## 3. 절대 원칙

### 3.1 구현 검증 금지

다음과 같은 테스트는 작성하지 않는다:

- mock 객체 verify 기반 테스트
- 내부 메서드 호출 여부 검증
- 특정 클래스 구조에 의존하는 테스트

테스트는 "decrease()가 호출되었는가?"를 묻지 않는다.
테스트는 "그래서 재고가 실제로 줄었는가?"를 묻는다.

---

### 3.2 API 경계에서 검증한다

모든 테스트는 시스템 경계(API)에서 시작한다.

- When: HTTP 요청을 보낸다.
- Then: HTTP 응답을 검증한다.
- And: 후속 API를 호출해 상태 변화를 확인한다.

UI 변경이나 내부 구조 변경에 영향을 받지 않도록 설계한다.

---

### 3.3 실패 시나리오를 반드시 포함한다

행동 기반 테스트는 성공만 검증하지 않는다.

실패 시:
- HTTP 에러 계약을 검증한다.
- 상태가 변경되지 않았음을 검증한다.

실패 시 상태 불변을 통해
트랜잭션 일관성과 롤백을 간접적으로 증명한다.

---

## 4. 리팩터링 보호 원칙

이 테스트는 리팩터링을 보호해야 한다.

내부 구조가 다음과 같이 변경되어도:
- Service 분리
- 트랜잭션 경계 변경
- Repository 구조 변경

다음 조건이 유지된다면 테스트는 통과해야 한다:
- 비즈니스 결과가 동일하다
- API 계약이 동일하다

구현이 바뀌어도 행동이 유지되면 테스트는 깨지지 않아야 한다.

---

## 5. Claude의 작업 절차

### Step 1. 핵심 행동 식별

Claude는 다음 기준으로 최소 5개 이상의 핵심 행동을 선정한다:

- 상태 변화가 발생하는 기능
- 비즈니스 리스크가 큰 기능
- 실패 시나리오가 명확한 기능
- 리팩터링 시 깨질 가능성이 높은 경계 기능

출력:
- 행동 목록 + 선정 이유

---

### Step 2. 시나리오 설계

각 행동에 대해:

- 성공 시나리오
- 실패 시나리오
- 상태 변화 또는 상태 불변 검증 방법

가능하면 "다음 행동"으로 이전 행동을 검증한다.

예:
- 주문 생성 → 주문 조회로 존재 확인
- 결제 → 잔액 조회로 차감 확인

---

### Step 3. 테스트 데이터 전략 수립

우선순위:
1. API를 통한 데이터 준비
2. 테스트 전용 seed/fixture
3. 불가피한 경우 DB 직접 조회

DB 직접 조회는 최소화한다.

테스트 간 데이터 충돌이 발생하지 않도록 격리 전략을 제안한다.

---

### Step 4. RestAssured 인수 테스트 작성

- Given / When / Then 구조로 작성
- HTTP 응답 계약 검증
- 후속 API 호출로 상태 검증
- 실패 시 상태 불변 검증 포함

---

## 6. 금지 사항

- BDD 도구 사용 금지 (Cucumber, Karate 등)
- mockito verify 기반 테스트 작성 금지
- 내부 클래스 구조를 전제로 한 테스트 작성 금지
- 테스트 통과를 위해 비즈니스 로직을 왜곡하는 수정 제안 금지

---

## 7. 문서화 요구사항

Claude는 다음 문서를 함께 생성해야 한다:

1) TEST_STRATEGY.md
- 검증할 행위 목록 및 선정 기준
- 테스트 데이터 전략
- 검증 전략
- 주요 의사결정

2) AI 활용 문서
- 어떤 질문을 했는가
- Claude의 제안을 어떻게 검증/수정했는가
- 최종적으로 사람이 선택한 설계 이유는 무엇인가

---

## 8. 최종 목표

이 프로젝트의 테스트는
"설계를 보호하는 테스트"가 아니라
"행동을 보호하는 테스트"여야 한다.

단위 테스트는 설계를 돕고,
인수 테스트는 리팩터링을 돕는다.

Claude는 항상 이 원칙을 기준으로 제안해야 한다.
