# USING_AI.md - AI 활용 문서

## 1. 어떤 질문을 했는가

### Q1. 프로젝트 분석 및 핵심 행동 식별 요청

> "핵심 행동 식별을 해서 project-analysis.md라는 파일을 만들어줘.
> 프로젝트 구조, 계층 구조, 도메인 모델, 엔티티 정보, 사용 가능한 API,
> 프로젝트 내부적으로 이상한 점이나 결함이라고 의심되는 부분도 포함해줘"

- CLAUDE.md의 Step 1(핵심 행동 식별)을 수행하기 위한 사전 작업으로, 프로젝트 전체 분석을 먼저 요청
- 단순히 행동 목록만이 아니라, 프로젝트 구조와 결함까지 포함하도록 범위를 확장

### Q2. TEST_STRATEGY.md 작성 요청

> "지금까지의 내용으로 TEST_STRATEGY.md 작성해줘"

- project-analysis.md의 분석 결과를 기반으로, CLAUDE.md가 요구하는 테스트 전략 문서 작성을 요청

### Q3. 테스트 데이터 격리 전략 심화 요청

> "test_strategy.md에서 테스트 데이터 전략 수립에 대해 조금 더 고민해보자.
> 다시 한 번 검토하고 좀 더 구체적으로 격리 전략을 제안하고 그 이유를 말해줘"

- Claude의 초안이 `@DirtiesContext 또는 @BeforeEach DB 초기화`라고만 적혀 있어 구체성이 부족하다고 판단
- 4가지 격리 전략 후보(DirtiesContext, Repository deleteAll, SQL TRUNCATE, 고유 데이터)를 비교 분석하도록 요청

### Q4. main 패키지 수정 없이 격리 구현 요청

> "DatabaseCleaner는 main 패키지에서 코드를 추가해야 되는거야?
> test 패키지 내부에서만 테스트 코드를 작성하는 경우만 가능하다고 한다면
> 어떻게 다른 방법을 선택해야 돼?"

- Claude가 제안한 `@Component DatabaseCleaner`가 main 패키지에 테스트 전용 코드를 넣는 문제를 지적
- 제약 조건(test 패키지 내부에서만 해결)을 명시하고 대안을 요청

### Q5. 비정상 입력 시나리오 추가 요청

> "오류 작동에 대해서 조금 더 다양한 케이스를 추가해보고 싶어.
> 예를 들어 값이 null이거나 음수, 0일 수 있는 거잖아?
> 이 예시처럼 해당 프로그램을 사용자가 행위를 했을 때 발생할 수 있는
> 더 다양한 오류 상황에 대해서 테스트할 수 있는 시나리오를 test_strategy.md에 추가해줘"

- 기존 시나리오가 성공 케이스 위주였으므로, 사용자 관점에서 발생 가능한 비정상 입력을 구체적인 예시(null, 음수, 0)와 함께 요청
- Claude가 코드를 분석하여 `Option.decrease(-5)` 시 재고가 증가하는 명확한 버그를 발견하는 계기가 됨

### Q6. 시나리오 구조 변경 + 입력 외 예외 상황 추가 요청

> "지금은 정상 시나리오 / 비정상 시나리오 이렇게 나눴는데
> 이렇게 작성하지 말고 도메인별로 나눈 다음에 성공 시나리오 / 실패 시나리오 이렇게 나눠주고
> 꼭 입력에 대한 예외가 아니더라도 발생할 수 있는 예외 상황을 더 추가해서 작성해줘"

- Q5로 추가된 비정상 시나리오가 기존 정상 시나리오와 분리되어 있어, 도메인별로 재구성하도록 요청
- 입력값 문제뿐 아니라 시스템 상태에 따른 예외(존재하지 않는 리소스, 헤더 누락, 요청 바디 없음 등)도 포함하도록 범위를 확장
- 이 요청으로 테스트 클래스 구조와 메서드 매핑도 함께 업데이트됨

---

## 2. Claude의 제안을 어떻게 검증/수정했는가

### 2.1 핵심 행동 목록 수정

Claude는 최초 6개의 핵심 행동을 제안했다:

| # | Claude 원안 | 최종 |
|---|------------|------|
| 1 | 카테고리 생성 | 유지 |
| 2 | 상품 생성 | 유지 |
| 3 | 상품 조회 | 유지 |
| 4 | 선물하기 (재고 차감) | 유지 |
| 5 | 선물하기 실패 (재고 부족) | 유지 |
| 6 | 존재하지 않는 리소스 참조 시 실패 | **삭제** |

**수정 이유**: 6번 항목("존재하지 않는 리소스 참조 시 실패")은 별도의 핵심 행동으로 분리하기보다, 각 시나리오의 실패 케이스 안에서 자연스럽게 다루는 것이 적절하다고 판단하여 제거. 예를 들어 "존재하지 않는 카테고리로 상품 생성 실패"는 상품 생성 시나리오의 실패 케이스로 포함됨.

### 2.2 테스트 데이터 격리 전략 수정 (2회)

**1차 수정 - 격리 전략 구체화**

Claude 초안은 격리 전략을 한 줄로만 언급했다:
> `@DirtiesContext 또는 @BeforeEach에서 DB 초기화`

이를 4가지 후보 전략으로 비교 분석하도록 요청했고, Claude는 전략 C(SQL TRUNCATE + DatabaseCleaner)를 제안했다.

**2차 수정 - main 패키지 수정 금지 제약 추가**

Claude의 DatabaseCleaner 제안은 `@Component`로 main 패키지에 배치하는 구조였다. 이는 테스트 전용 코드가 프로덕션 코드에 섞이는 문제가 있어, "test 패키지 내부에서만 해결해야 한다"는 제약을 추가했다.

Claude는 두 가지 대안을 제시했고, 최종적으로 더 단순한 방식을 선택했다:

| 대안 | 설명 | 최종 |
|------|------|------|
| `@TestConfiguration` + DatabaseCleaner 클래스 | test 패키지에 별도 클래스 + Bean 설정 | 탈락 (보일러플레이트 과다) |
| BaseAcceptanceTest + `@BeforeEach` 직접 TRUNCATE | 부모 클래스에서 JdbcTemplate으로 직접 처리 | **채택** |

**채택 이유**: 엔티티 5개, 테스트 클래스 3개 규모에서 JPA 메타모델 자동화나 별도 클래스 분리는 오버엔지니어링. 부모 클래스 한 곳에서 테이블 5개를 TRUNCATE하는 것이 가장 명확하고 유지보수가 쉬움.

### 2.3 시나리오 구조 변경 및 확장

**구조 변경 요청**

Claude의 초안은 시나리오를 "정상 시나리오(2.1~2.5) / 비정상 입력 시나리오(2.6~2.8)"로 나누었다. 이를 도메인별(카테고리 / 상품 / 선물하기)로 재구성하고, 각 도메인 안에서 성공/실패를 나누도록 요청했다.

| 항목 | Claude 초안 | 최종 |
|------|-----------|------|
| 분류 기준 | 정상/비정상 | **도메인별** (카테고리, 상품, 선물하기) |
| 하위 구분 | 없음 (섞여 있음) | 도메인 내 **성공/실패** 분리 |

**변경 이유**: 도메인별로 나누면 테스트 클래스 구조와 1:1로 대응되어, 시나리오 → 코드 추적이 쉬움.

**시나리오 확장 요청**

입력값 검증(null, 음수, 0) 외에도, 시스템 상태에 따라 발생할 수 있는 예외 상황을 추가하도록 요청했다.

Claude가 코드를 분석하여 추가로 발견한 시나리오:

| ID | 시나리오 | 발견 방법 |
|----|---------|----------|
| S-CAT-2 | 여러 카테고리 생성 후 전체 조회 | 목록 조회의 정확성 검증 필요성 |
| S-PRD-2 | 서로 다른 카테고리에 상품 각각 생성 | 카테고리 연결 정확성 |
| S-GIFT-2 | 연속 선물 누적 차감 | 단일 차감만으로는 누적 정확성을 보장할 수 없음 |
| S-GIFT-3 | 재고 전부 소진 경계값 | 기존 2.5에서 분리 (성공 단계와 실패 단계를 독립 시나리오로) |
| F-GIFT-7 | 존재하지 않는 받는 회원에게 선물 | FakeGiftDelivery가 수신자(getTo)를 조회하지 않는 코드 분석에서 발견 |
| F-GIFT-9 | 요청 바디 없이 선물하기 | @RequestBody 필수 여부 검증 |

특히 **F-GIFT-7**은 Claude의 코드 분석에서 나온 발견이다: `FakeGiftDelivery.deliver()`가 `gift.getFrom()`(보내는 사람)만 조회하고 `gift.getTo()`(받는 사람)은 조회하지 않아, 존재하지 않는 수신자에게 선물이 성공하는 결함을 가시화할 수 있다.

**최종 시나리오 규모 변화**

| 항목 | 초안 | 최종 |
|------|------|------|
| 성공 시나리오 | 3개 | 7개 |
| 실패 시나리오 | 6개 | 14개 |
| 합계 | 9개 | **21개** |
